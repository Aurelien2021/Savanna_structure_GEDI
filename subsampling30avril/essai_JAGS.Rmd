---
title: "First test complete model"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, echo=FALSE, include = FALSE}
# Cleaning the environment
rm(list=ls())
# Getting the paths
source("paths.R")
getwd()
# Libraries
library(rjags)
```

```{r data_loading, echo=FALSE, include = FALSE}

table_region <- readRDS(
                file.path(
                  path_to_Savanna_structure_GEDI_folder,
                  "subsampling30avril",
                  "final_table_10km_associated_to_300km_cell.RDS")
                )

head(table_region,2)

             
data <- list(
             N = nrow(table_region), 
             prec_data = table_region$mean_precip,
             fire_data = table_region$fire_freq, 
             cc_data = table_region$canopy_cover
             ) 
```


```{r model, echo=FALSE, include = FALSE}
# model and jags inference
  model <-  "
  model {
    
    for (i in 1:N){
      
      sigmo_pluie[i] = (1/ (1+ a*exp(-lambda*(prec_data[i]-pt_inflexion_grass)) ) )
      # curve(1/(1+exp(-0.0035*(x-600))),xlim=c(0,3000),ylim=c(0,1))
      
      canopy_influence[i] = delta_max + (1-cc_data[i])*delta_min
      sigmo_competition[i] = (2/(1+ a*exp(canopy_influence[i]*(prec_data[i]-pt_inflexion_grass)) ) )
      
      grassB[i] = K_G_t_f_pluie_max*sigmo_pluie[i]*sigmo_competition[i]
  }
    
  for (i in 1:N){
      
      fire_data[i] ~ dnorm(grassB[i]**2/(grassB[i]**2 + pt_inflexion_feu**2) , 1/0.01)T(0,1)
      
  }
  
  # priors
  
  K_G_t_f_pluie_max ~ dunif(13,30)
  # 13 vraiment un minimum, 30 Ã§a fait 30/10**4 = 0.003 t = 3kg par m-2
  
  pt_inflexion_feu ~ dunif(2,4.5)
  # a priori compris dans cette zone...
  
  delta_min ~ dnorm(0.0017,1/0.001**2)T(0,)
  # curve(dnorm(x,0.0017,sd=0.001),xlim=c(0.001,0.01))

  delta_max ~ dnorm(0.0088,1/0.001**2)T(0,)
  # curve(dnorm(x,0.0088,sd=0.001),xlim=c(0.001,0.01))

  pt_inflexion_grass ~ dnorm(600,1/600**2)T(0,)
  # curve(dnorm(x,600,sd=600),xlim=c(0,3000))
  
  lambda ~ dnorm((0.0088-0.0017)/2,1/0.003**2)T(0,)
  # curve(dnorm(x,(0.0088-0.0017)/2,sd=0.003),xlim=c(0,0.02))
  
  a ~ dnorm(5,1/10**8)T(0,)
  # mettre un log prior
  # curve(1/(1+50*exp(-0.0035*(x-600))),xlim=c(-3000,3000),ylim=c(0,1))
  # curve(dnorm(x,5,sd=10**8),xlim=c(0,3000)) 
  
  }
"

inits <- list(
               list(
                     K_G_t_f_pluie_max = 15,
                     pt_inflexion_grass = 600,
                     a = 1,
                     pt_inflexion_feu = 2.1,
                     delta_min = 0.0017,
                     delta_max = 0.0088,
                     lambda = 0.0025
                    ),
               
               list(
                     K_G_t_f_pluie_max = 20,
                     pt_inflexion_grass = 800,
                     a = 10,
                     pt_inflexion_feu = 2.6,
                     delta_min = 0.0017,
                     delta_max = 0.0088,
                     lambda = 0.0065
               ),
               
               list(
                     K_G_t_f_pluie_max = 25,
                     pt_inflexion_grass = 400,
                     a = 1000,
                     pt_inflexion_feu = 3.5,
                     delta_min = 0.0017,
                     delta_max = 0.0088,
                     lambda = 0.0040
               )   
)
```


```{r mcmc, echo=FALSE, include = FALSE}
#   
m <- rjags::jags.model(
                        textConnection(model),
                        inits = inits,
                        data = data,
                        n.chains = length(inits),
                        n.adapt = 10**3 # est-ce suffisant ?
                        )
# burnin
update(m, 2*10**3)
mcmc <- rjags::coda.samples(
                             m,
                             variable.names = c(
                                                "K_G_t_f_pluie_max",
                                                 "pt_inflexion_grass",
                                                 "a",
                                                 "pt_inflexion_feu",
                                                 "delta_min",
                                                 "delta_max",
                                                 "lambda"
                                                ),
                             n.iter = 5*10**3,
                             thin = 10
                             )
```


```{r save_file, echo=FALSE, include = FALSE}
save_rds_files = TRUE

if(save_rds_files==TRUE){

        saveRDS(mcmc,
                file.path(
                  path_to_Savanna_structure_GEDI_folder,
                  "subsampling30avril",
                  "JAGS14mai9h.RDS")
                )
}

mcmc <- readRDS(
                file.path(
                  path_to_Savanna_structure_GEDI_folder,
                  "subsampling30avril",
                  "JAGS14mai9h.RDS"
                )
)
```

```{r summaries, echo=TRUE, include = TRUE}
print(summary(mcmc))
summary(mcmc)$statistics

K_G_t_f_pluie_max  = summary(mcmc)$statistics["K_G_t_f_pluie_max",1]
a                  = summary(mcmc)$statistics["a",1]
delta_max          = summary(mcmc)$statistics["delta_max",1]
delta_min          = summary(mcmc)$statistics["delta_min",1]
lambda             = summary(mcmc)$statistics["lambda",1]
pt_inflexion_feu   = summary(mcmc)$statistics["pt_inflexion_feu",1]
pt_inflexion_grass = summary(mcmc)$statistics["pt_inflexion_grass",1]

curve(K_G_t_f_pluie_max/(1+a*exp(-(lambda)*(x-pt_inflexion_grass))),xlim=c(0,3000))
```

```{r mcmc_diagnosis, echo=TRUE, include = TRUE}
autocorr.plot(mcmc[[1]], ask = "TRUE",lag.max=10**3)
par(mar = c(2,0,0,0))
# c(bottom, left, top, right)
# default is c(5, 4, 4, 2)
plot(mcmc, trace = T)
gelman.diag(mcmc)

as.data.frame(mcmc[[1]])$a
as.data.frame(mcmc[[1]])$K_G_t_f_pluie_max

cor(as.data.frame(mcmc[[1]]))
```


