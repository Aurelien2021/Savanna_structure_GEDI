---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
# For the accents é ù û etc
options(Encoding="latin1")
# Cleaning the environment
rm(list=ls())
# Getting the paths
source("paths.R",encoding="latin1")
# Setting the current path
path_to_R_folder = file.path(
                             path_to_Savanna_structure_GEDI_folder,
                             "R"
                             )
setwd(path_to_R_folder)
getwd()

# Libraries
library(fst)
library(ggplot2)

setwd(path_to_R_folder)
```

```{r}
# On a créé sub_sample_Guinean.RDS de taille 10**4 avec generate_sub_samples_of_3_ecoregions.Rmd

# Essayons brms

# D'abord test brms sans car()

setwd(path_to_R_folder)

# On charge le sub_sample 10**4 lignes Guinean généré avec generate_sub_samples_of_3_ecoregions.Rmd

sub_sample_Guinean <- readRDS("sub_sample_Guinean.RDS")
nrow(sub_sample_Guinean)
```

```{r}
require(brms)

default_prior = get_prior(
                          formula = rh98 ~ mean_precip + mean_temp  + fire_freq,
                          # +  (1 | machin) pour effet aléatoire machin
                          
                          data = sub_sample_Guinean,
                          
                          family = brmsfamily(family = "Gamma")
                          # à voir comment spécifier le lien et lequel est utilisé
                          )

View(default_prior)

# On pourra mettre des priors loi normale au lieu des prior plats impropres pour la pluie etc.
```

```{r}
# View(sub_sample_Guinean)

start <- Sys.time()
print(start)

mod <- brm(

            formula = rh98 ~ mean_precip + mean_temp + fire_freq,

            data = sub_sample_Guinean,

            family = brmsfamily(family = "Gamma"),
            # à voir comment spécifier le lien et lequel est utilisé

            prior = NULL,
            # prior = NULL pour utiliser les priors par défaut,

            warmup = 10**3,
            iter = 5*10**3,
            thin = 10,
            
            file = "brms1_on_sub_sample_10_4_Guinean.RDS",
            # enregistre le fichier tel quel
            # si le fichier existe déjà avec une sauvegarde précédente de brm()
            # ça charge le fichier
            
            chains = 3,
            cores = 3,
            # Number of cores to use when executing the chains in parallel.

            # control = list(adapt_delta = 0.95),
            # A named list of parameters to control the sampler's behavior.
            # On peut être amené à ajouter ce paramètre suite à une erreur qui suggère
            # de rajouter cette commande. Je ne sais pas pourquoi.

            silent = 0
            # Pour avoir les détails de l'évolution de la chaîne
            )

print(Sys.time() - start)
```

```{r}
summary(mod)
plot(mod,ask=FALSE)
```

```{r}
# Allez maintenant on met car()
# Test avec une matrice de voisinage au hasard pour voir le temps de calcul déjà


```



