---
title: "Untitled"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
# Cleaning the environment
rm(list=ls())
# Getting the paths
source("paths.R")
# Setting the current path
path_to_R_folder = file.path(
                             path_to_Savanna_structure_GEDI_folder,
                             "R"
                             )
setwd(path_to_R_folder)
getwd()

# Libraries
library(terra)
# Encoding :
print("é è û")
```

```{r}
# Data loading

# complete_table = readRDS(file = file.path(
#                                            path_to_Savanna_structure_GEDI_folder,
#                                            "rawdata",
#                                            "complete_corresponding_table_without_duplicate_standardized.RDS"
#                                            )
#                           )

# To verify the standardisation and NAs :
summary(complete_table)
colnames(complete_table)
colSums(is.na(complete_table))
```

```{r}
grid_of_distant_cells <- function(target_nrow,target_ncol,plot_grid=FALSE){
  
  # first sub-grid
  conserved1 <- rep(rep(c(TRUE,FALSE),each=target_ncol),times=target_nrow%/%2)
  if (target_nrow%%2==1){ conserved1 <- c(conserved1,rep(TRUE,times=target_ncol)) }
  
  # second sub-grid
  if (target_ncol%%2==0){ 
    conserved2 <- rep(rep(c(TRUE,FALSE),times=target_ncol%/%2),times=target_nrow)
  }
  if (target_ncol%%2==1){ 
    conserved2 <- rep(c(rep(c(TRUE,FALSE),times=target_ncol%/%2),TRUE),times=target_nrow)
  }
  
  # final sub-grid
  conserved = rep(TRUE,length(conserved1))
  for (s in 1:length(conserved)){
    if(conserved1[s] == FALSE | conserved2[s] == FALSE){conserved[s] = FALSE}
  }
  
  if (plot_grid==TRUE){
    test_conserved <- matrix(conserved,ncol=target_ncol,byrow=TRUE)
    print(paste(target_nrow,"x",target_ncol,"matrix"))
    print(paste("length(conserved) =",length(conserved)))
    print(test_conserved)
  }
  
  return(conserved)
}

# Tests of odd/even cases :
conserved <- grid_of_distant_cells(3,5,TRUE)
conserved <- grid_of_distant_cells(4,5,TRUE)
conserved <- grid_of_distant_cells(3,6,TRUE)
conserved <- grid_of_distant_cells(4,6,TRUE)
```

```{r}
require(sf)

# Saving all ecoregions sub (grid)-sampled in .RDS tables in transform data

cell <- 10**4
# set a cell length, in meter

names = c("Guinean_forest-savanna","West_Sudanian","Sahelian_Acacia") # for testing the loop
# names = unique(complete_table$ecoregion) for all ecoregions

save_rds_files = FALSE
save_coords_TRUE_geojson = FALSE
save_coords_TRUE_geojson = FALSE

for (name in names){
  
  complete_table = readRDS(file = file.path(
                                           path_to_Savanna_structure_GEDI_folder,
                                           "rawdata",
                                           "complete_corresponding_table_without_duplicate_standardized.RDS"
                                           )
                          )
  
  print(name)
  
  x <- complete_table[complete_table[,"ecoregion"] == name, ]
  
  rm(complete_table)

  x <- cbind(x$x,x$y,x)
  
  # print("colnames(x)")
  # print(colnames(x))
  # 
  # print("ncol(x)")
  # print(ncol(x))
  
  colnames(x)[1] = "x_TRUE"
  colnames(x)[2] = "y_TRUE"
  
  # print("colnames(x)")
  # print(colnames(x))
  
  #1) setting resolution
  # from data.frame to spatvector
  x <- terra::vect(x, geom = c("x", "y"), crs = "+proj=longlat +datum=WGS84") 
  # get x "window" : xmin, xmax, ymin, ymax
  x_ext <- terra::ext(x)
  dx <- geodist::geodist(x = c(x_ext[1],x_ext[3]), y = c(x_ext[2],x_ext[3]), measure = "haversine")
  dy <- geodist::geodist(x = c(x_ext[1],x_ext[3]), y = c(x_ext[1],x_ext[4]), measure = "haversine")
  (target_ncol <- round(dx/cell))
  (target_nrow <- round(dy/cell))
  
  #2) resampling
  y <- terra::rast(x, ncol = target_ncol, nrow = target_nrow)
  z <- terra::rasterize(x, y, fun = sample, size = 1, field = colnames(terra::values(x)))
  # fun = sample , size = 1 to get one random sample in the cell
  trsf_data <- data.frame(cbind(crds(y), values(z)))
  
  rm(x)
  rm(y)
  rm(z)
  
  conserved <- grid_of_distant_cells(target_nrow,target_ncol)
  
  # print("length(conserved)")
  # print(length(conserved))
  # 
  # print("summary(conserved)")
  # print(summary(conserved))
  # 
  # print("mean(conserved)")
  # print(mean(conserved))

  conserved_indices = rep(NA,length(conserved))
  
  # deletions
  for (s in 1:length(conserved)){
    if(conserved[s] == TRUE){conserved_indices[s] = s}
  }
  
  # print("conserved_indices")
  # print(conserved_indices[1:1000])
  
  conserved_indices <- conserved_indices[!is.na(conserved_indices)]
  
  # print("conserved_indices")
  # print(conserved_indices[1:1000])
  # 
  # print("sum(is.na(conserved_indices))")
  # print(sum(is.na(conserved_indices)))
  # 
  # print("length(conserved_indices)")
  # print(length(conserved_indices))
  # 
  # print("summary(conserved)")
  # print(summary(conserved))
  # 
  # print("summary(conserved_indices)")
  # print(summary(conserved_indices))
  # 
  # print("nrow(trsf_data)")
  # print(nrow(trsf_data))

  conserved_sub_table <- trsf_data[conserved_indices,]
  
  # print("nrow(conserved_sub_table)")
  # print(nrow(conserved_sub_table))
  
  colnames(conserved_sub_table)[1] = "x_center_cell"
  colnames(conserved_sub_table)[2] = "y_center_cell"
  
  # print("colnames(conserved_sub_table)")
  # print(colnames(conserved_sub_table))
  
  conserved_sub_table <- conserved_sub_table[
                        complete.cases(conserved_sub_table[,c("x_center_cell",
                                                              "y_center_cell",
                                                              "x_TRUE",
                                                              "y_TRUE",
                                                              "rh98",
                                                              "canopy_cover",
                                                              "fire_freq",
                                                              "mean_precip",
                                                              "mean_temp",
                                                              "ecoregion",
                                                              "fire_freq_NA",
                                                              "fire_freq_std",
                                                              "mean_precip_std",
                                                              "mean_temp_std"
                                                               )
                                                           ]
                                        ),]
  
  print("nrow(conserved_sub_table)")
  print(nrow(conserved_sub_table))
  
  # Data saving in the transformed_data folder
  
  if (save_rds_files ==TRUE){
    
  saveRDS(
          object = conserved_sub_table,
          file = file.path(
                           path_to_Savanna_structure_GEDI_folder,
                           "transformed_data",
                           paste0(name,".RDS")
                           )
          )    
  
  print(paste(paste0(name,".RDS"),"DONE"))
  
  }
  
  if (save_center_cells_geojson ==TRUE){
  
  sf_obj <- st_as_sf(conserved_sub_table,coords = c("x_center_cell", "y_center_cell"),crs = 4326)

  st_write(
           sf_obj,
           file.path(path_to_Savanna_structure_GEDI_folder,
                     "transformed_data",
                     paste0(name,"_center_cells.geojson")
                     )
           )
  
  print(paste(paste0(name,"center_cells.geojson"),"DONE"))

  }
  
  if (save_coords_TRUE_geojson ==TRUE){
    
  sf_obj2 <- st_as_sf(conserved_sub_table,coords = c("x_TRUE", "y_TRUE"),crs = 4326)

  st_write(
           sf_obj2,
           file.path(path_to_Savanna_structure_GEDI_folder,
                     "transformed_data",
                      paste0(name,"_TRUE_positions.geojson")
           )
  )
  
  print(paste(paste0(name,"TRUE_positions.geojson"),"DONE"))
  
  }
  
}
```

```{r}

```


```{r}

```
